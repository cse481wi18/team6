<link rel="import" href="../bower_components/polymer/polymer-element.html">

<link rel="import" href="../bower_components/ros-action-client/ros-action-client.html">
<link rel="import" href="../bower_components/ros-topic/ros-topic.html">
<link rel="import" href="../bower_components/ros-websocket/ros-websocket.html">


<link rel="import" href="recycle-ui-class-card.html">

<dom-module id="recycle-ui-class-column">
  <template>
    <style>
      :host {
        position: relative;
        text-align: center;
      }

      .arrow-wrapper {
        margin-top: 5px;
      }

      h3 {
        margin: 10px 0 10px 0;
      }
    </style>
    <!-- ROS setup -->
    <ros-websocket auto ros="{{ros}}"
      url="{{url}}"
      on-connection="_handleConnection"
      on-close="_handleClose"
      on-error="_handleError">
    </ros-websocket>

    <ros-topic
      id="logTopic"
      ros="{{ros}}"
      topic="recycle_ui/get_{{type}}_log_page"
      msg-type="recycle_ui/GetLogPage">
    </ros-topic>

    <ros-topic auto
      ros="{{ros}}"
      topic="recycle_ui/active_{{type}}_logs"
      msg-type="recycle_ui/ActiveLogs"
      last-message="{{items}}"
      on-message="_handleResponse">
    </ros-topic>

    <ros-action-client  ros="{{ros}}"
      id="correctionClient"
      server="/recycle/dblog_action"
      action-type="recycle_msgs/DbLogAction"
      last-result="{{lastResult}}"
      on-result="_handleCorrectionResult">
    </ros-action-client>

    <div>
      <h3>[[title]]</h3>

      <template is="dom-repeat" items="[[items.log_items]]">
        <recycle-ui-class-card class="item-card" item="{{item}}"></recycle-ui-class-card>
      </template>

      <div class="arrow wrapper">
        <paper-icon-button icon="icons:arrow-back" on-tap="_prevItems"></paper-icon-button>
        <paper-icon-button icon="icons:arrow-forward" on-tap="_nextItems"></paper-icon-button>
      </div>
    </div>
  </template>

  <script>
    NUM_DISPLAY = 3;
    /**
     * @customElement
     * @polymer
     */
    class ClassificationColumn extends Polymer.Element {
      static get is() { return 'recycle-ui-class-column'; }
      static get properties() {
        return {
          type: String,
          title: String,
          lastId: {
              type: Number,
              value: 0
          },
          items: {
            type: Object,
            value: {
              log_items: []
            }
          }
        };
      }

      _handleConnection() {
        this.status = 'Connected to the websocket server.';
        this._nextItems();
      }

      _handleClose() {
        this.status = 'Closed connection to the websocket server.';
        console.log(this.status);
      }

      _handleError() {
        this.status = 'Error connecting to the websocket server.';
        console.log(this.status);
      }

      _nextItems() {
        console.log('Fetching next');
        this._getItems(NUM_DISPLAY);
      }

      _prevItems() {
        console.log('Fetching prev');
        this._getItems(-1 * NUM_DISPLAY);
      }

      _getItems(num) {
        console.log('Getting', num, 'items starting at', this.lastId, 'for', this.type);
        var msg = {
          starting_log_num: this.lastId,
          page_size: num
        };

        this.$.logTopic.publish(msg);
      }

      _correctItem(evt) {
        // modify the log item to have the corrected label
        console.log('Correcting item:', evt.detail);
        evt.detail.item.actual_category = evt.detail.correctLabel;
        var goal = {
          log_item: evt.detail.item
        };

        // find smallest id and ask for one before that to refresh
        var logItems = this.items.log_items;
        var smallestId = logItems[0].log_id;
        for (var i = 1; i < logItems.length; i++) {
          if (logItems[i].log_id < smallestId) {
            smallestId = logItems[i].log_id;
          }
        }

        // hack to make sure we get the first item again
        this.lastId = smallestId - 1;
        console.log('new lastId', this.lastId);

        // important to send this after we update the field
        this.$.correctionClient.send(goal);
      }

      _handleCorrectionResult(evt) {
        console.log('Correction: received', evt.detail);
        this._nextItems();
      }

      _handleResponse(evt) {
        var msg = evt.detail;

        // update to last id
        var logItems = this.items.log_items;
        var maxId = 0;
        for (var i = 0; i < logItems.length; i++) {
          if (logItems[i].log_id > maxId) {
            maxId = logItems[i].log_id;
          }
        }
        if (logItems.length > 0) {
          this.lastId = maxId;
        }
        console.log(this.type, 'Message', msg, this.items, 'id', this.lastId);
      }

      ready() {
        super.ready();
        this.addEventListener('labelCorrection', this._correctItem);
      }
    }

    window.customElements.define(ClassificationColumn.is, ClassificationColumn);
  </script>
</dom-module>
